---
title: BirdNET Demo
layout: layouts/base.njk
permalink: "/upload/"
---

<section class="page-header">
  <div class="container">
    <h1 class="page-title">BirdNET Demo (Browser Inference)</h1>
    <p class="lead text-muted mb-0">
      Run BirdNET locally with TensorFlow.js. Optionally refine with geo (lat / lon).
    </p>
    <div class="text-muted small mt-4">
      Code adapted from
      <a href="https://github.com/georg95/birdnet-web" target="_blank" rel="noopener">georg95/birdnet-web</a>.
    </div>
  </div>
</section>

<section class="py-5">
  <div class="container">

    <form id="fileform" class="mb-4" enctype="multipart/form-data">
      <div id="dropzone" class="upload-dropzone text-center p-4 border border-dashed rounded bg-light">
        <p class="mb-2 small text-muted">Drag & drop audio or choose a file (48 kHz preferred, WAV/MP3)</p>
        <input id="fileupload" name="file" type="file" accept="audio/*" hidden>
        <button type="button" id="chooseBtn" class="btn btn-sm btn-outline-secondary">Choose file</button>
        <div class="small mt-2 text-muted" id="fileInfo"></div>
      </div>
    </form>

    <div id="player" class="mb-3">
      <div class="spectro-wrapper" id="spectro-wrapper">
        <div id="ws-container" class="ws-container position-relative">
          <div id="playCursor"></div>
        </div>
        <div id="spectro-controls" class="spectro-controls d-none align-items-center gap-2 mt-3 flex-wrap">
          <button id="playBtn" class="btn btn-sm btn-primary" title="Play" aria-label="Play">▶</button>
          <button id="pauseBtn" class="btn btn-sm btn-primary btn-control" title="Pause" aria-label="Pause">❚❚</button>
          <button id="restartBtn" class="btn btn-sm btn-primary btn-control" title="Restart" aria-label="Restart">↺</button>
          <div id="timeDisplay" class="small text-white-50 ms-2">0:00 / 0:00</div>
        </div>
      </div>
    </div>

    <!-- Settings BELOW spectrogram; hidden until audio is loaded -->
    <div id="settingsPanel" class="card card-body mb-3 d-none">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label for="langSelect" class="form-label small mb-1">Labels language</label>
          <select id="langSelect" class="form-select form-select-sm">
            <option value="auto" selected>Auto (browser)</option>
            <option value="en_us">English (US)</option>
            <option value="en_uk">English (UK)</option>
            <option value="de">Deutsch</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="it">Italiano</option>
            <option value="nl">Nederlands</option>
            <option value="pt">Português</option>
            <option value="fi">Suomi</option>
            <option value="sv">Svenska</option>
            <option value="da">Dansk</option>
            <option value="no">Norsk</option>
            <option value="pl">Polski</option>
            <option value="cs">Čeština</option>
            <option value="sk">Slovenčina</option>
            <option value="ro">Română</option>
            <option value="sl">Slovenščina</option>
            <option value="hu">Magyar</option>
            <option value="ru">Русский</option>
            <option value="uk">Українська</option>
            <option value="tr">Türkçe</option>
            <option value="ar">العربية</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
            <option value="th">ไทย</option>
            <option value="zh">中文</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="latInput" class="form-label small mb-1">Latitude</label>
          <input type="number" step="0.0001" id="latInput" class="form-control form-control-sm" placeholder="e.g. 40.7812">
        </div>
        <div class="col-6 col-md-3">
          <label for="lonInput" class="form-label small mb-1">Longitude</label>
          <input type="number" step="0.0001" id="lonInput" class="form-control form-control-sm" placeholder="-73.9665">
        </div>
        <div class="col-6 col-md-2">
          <label for="overlapSelect" class="form-label small mb-1">Overlap (s)</label>
          <select id="overlapSelect" class="form-select form-select-sm">
            <option value="0.0" selected>0.0</option>
            <option value="0.5">0.5</option>
            <option value="1.0">1.0</option>
            <option value="1.5">1.5</option>
            <option value="2.0">2.0</option>
            <option value="2.5">2.5</option>
          </select>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <label class="form-label small mb-1 invisible">.</label>
          <button type="button" id="runBtn" class="btn btn-sm btn-primary">Run analysis</button>
        </div>
      </div>
      <div class="small text-muted mt-2">
        Pooling: mean exponential (smooth-max). Overlap controls hop size of 3s windows.
        Species with geo score ≤ 0.05 are hidden (set to 0).
      </div>
    </div>

    <!-- Separate status area -->
    <div id="statusArea" class="mb-3">
      <div id="statusLine" class="small text-muted">Waiting for audio…</div>
    </div>

    <div id="results" class="mb-3"></div>
    <div class="mb-4">
      <button id="downloadCsvBtn" class="btn btn-sm btn-outline-secondary d-none" disabled>Download pre-segment results</button>
    </div>
    
  </div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/spectrogram.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/minimap.min.js"></script>

<script type="module">
// Worker lifecycle (language is applied when you click Run)
const workerBase = '{{ "/js/birdnet-worker.js" | url }}';
const modelsRoot = '{{ "/models" | url }}';
let worker = null;
let workerLoaded = false;
let resolveWhenLoaded = null;
let currentWorkerLang = null; // track which language the current worker uses
let ws = null;
let chart = null;
let areaModelLoaded = false;
let lastPCM = null;  // last audio buffer

const WINDOW_SAMPLES = 144000; // 3s @ 48kHz

// Pretty labels on bars (no extra plugin dependency)
const ValueLabelPlugin = {
  id: 'valueLabel',
  afterDatasetsDraw(chart, args, opts) {
    const { ctx, scales } = chart;
    const meta = chart.getDatasetMeta(0);
    const data = chart.data.datasets[0].data;
    ctx.save();
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = '#444';
    ctx.textBaseline = 'middle';
    meta.data.forEach((bar, i) => {
      const val = data[i];
      if (val == null) return;
      const label = val.toFixed(3);
      const padding = 6;
      const x = Math.min(bar.x + 24, scales.x.getPixelForValue(1) - 4); // keep inside chart
      const y = bar.y;
      ctx.fillText(label, x, y);
    });
    ctx.restore();
  }
};
Chart.register(ValueLabelPlugin);

function makeWorkerUrl(selectedLang) {
  const qs = new URLSearchParams({ root: modelsRoot });
  if (selectedLang && selectedLang !== 'auto') qs.set('lang', selectedLang);
  return workerBase + '?' + qs.toString();
}
function attachWorker() {
  worker.onmessage = ({ data }) => {
    if(['load_model','warmup','load_geomodel','load_labels'].includes(data.message)){
      $('#statusLine').text('Loading model... '+(data.progress ?? '')+'%');
    }
    if(data.message === 'loaded'){
      workerLoaded = true;
      $('#statusLine').text('Model ready.');
      if (resolveWhenLoaded) { resolveWhenLoaded(); resolveWhenLoaded = null; }
    }
    if(data.message === 'predict_debug'){
      console.groupCollapsed('[birdnet] top-10 per batch');
      data.top10PerBatch.forEach(({ batch, max, mean, top10 }) => {
        console.groupCollapsed(`batch ${batch} · max=${max.toFixed(4)} · mean=${mean.toExponential(2)}`);
        console.table(top10.map(t => ({ name: t.name, confidence: +t.confidence.toFixed(4) })));
        console.groupEnd();
      });
      console.groupEnd();
    }
    if(data.message === 'segments'){
      // raw segment predictions stored for CSV export
      segmentPredictions = data.segments; // [{start,end,preds:[{index,confidence,geoscore,name,nameI18n}]}]
      $('#downloadCsvBtn').prop('disabled', false).removeClass('d-none');
    }
    if(data.message === 'pooled'){
      const useGeo = areaModelLoaded;
      const GEO_THRESH = 0.05;
      const items = data.pooled
        .map(x => {
          const filtered = useGeo ? (x.geoscore > GEO_THRESH ? x.confidence : 0) : x.confidence;
          return { ...x, filtered };
        })
        .sort((a,b) => b.filtered - a.filtered)
        .slice(0, 10);
      drawChart(items, useGeo ? 'filtered' : 'confidence');
      $('#statusLine').text('Top 10 results');
    }
    if(data.message === 'area-scores'){
      areaModelLoaded = true;
      $('#statusLine').text('Geo scores applied');
    }
  };
}
function newWorker(selectedLang) {
  if (worker) { try { worker.terminate(); } catch{} }
  workerLoaded = false;
  areaModelLoaded = false;
  currentWorkerLang = selectedLang || 'auto';
  worker = new Worker(makeWorkerUrl(currentWorkerLang));
  attachWorker();
}
function waitForLoaded(){
  if (workerLoaded) return Promise.resolve();
  return new Promise(res => { resolveWhenLoaded = res; });
}

function fmtTime(sec){ if(!sec||isNaN(sec)) return '0:00'; const m=Math.floor(sec/60); const s=Math.floor(sec%60); return m+':'+String(s).padStart(2,'0'); }

function initWaveSurfer(url){
  if(ws){ try{ ws.destroy(); } catch{} ws=null; }
  $('#spectro-controls').addClass('d-none');
  const SpectrogramPlugin = WaveSurfer.Spectrogram;
  const MinimapPlugin = WaveSurfer.Minimap;
  ws = WaveSurfer.create({
    container:'#ws-container',
    url,
    height:0,
    sampleRate:48000,
    waveColor:'transparent',
    progressColor:'transparent',
    cursorWidth:0
  });
  if(MinimapPlugin){
    ws.registerPlugin(MinimapPlugin.create({
      height:30,waveColor:'#a89f98',progressColor:'#2E261F',normalize:true
    }));
  }
  if(SpectrogramPlugin){
    ws.registerPlugin(SpectrogramPlugin.create({
      frequencyMax:12000,frequencyMin:300,fftSamples:512,labels:false,
      splitChannels:false,height:150,scale:'linear',colorMap:'roseus',gainDB:35,rangeDB:100
    }));
  }
  ws.on('ready',()=>{
    $('#timeDisplay').text('0:00 / '+fmtTime(ws.getDuration()));
    $('#spectro-controls').removeClass('d-none').addClass('d-flex');
    $('#settingsPanel').removeClass('d-none'); // show settings once audio is ready
  });
  ws.on('audioprocess',t=>$('#timeDisplay').text(fmtTime(t)+' / '+fmtTime(ws.getDuration())));
  ws.on('seek',()=>$('#timeDisplay').text(fmtTime(ws.getCurrentTime())+' / '+fmtTime(ws.getDuration())));
}

function drawChart(list, valueKey='confidence'){
  const labels = list.map(b => b.nameI18n || b.name);
  const data = list.map(b => b[valueKey] || 0);
  $('#results').html('<canvas id="predictionChart" height="'+Math.max(220, (labels.length*24+80))+'"></canvas>');
  if(chart) chart.destroy();
  const ctx = document.getElementById('predictionChart').getContext('2d');

  const bgColor = (c) => {
    const { chart } = c;
    const area = chart.chartArea;
    if (!area) return '#7dd3fc';
    const grad = chart.ctx.createLinearGradient(area.left, 0, area.right, 0);
    grad.addColorStop(0, '#22d3ee');   // cyan
    grad.addColorStop(0.5, '#60a5fa'); // sky
    grad.addColorStop(1, '#a78bfa');   // violet
    return grad;
  };

  chart = new Chart(ctx, {
    type:'bar',
    data:{
      labels,
      datasets:[{
        label: valueKey === 'filtered' ? 'Confidence (geo-filtered)' : 'Confidence',
        data,
        backgroundColor: bgColor,
        borderColor: '#0ea5e9',
        borderWidth: 1,
        borderSkipped: false,
        borderRadius: 8,
        barPercentage: 0.85,
        categoryPercentage: 0.9
      }]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      maintainAspectRatio:false,
      animation: {
        duration: 900,
        easing: 'easeOutQuart',
        delay: (ctx) => ctx.dataIndex * 30
      },
      scales:{
        x:{
          min:0, max:1,
          grid:{ color: 'rgba(0,0,0,0.06)' },
          ticks:{ callback:(v)=> Number(v).toFixed(1) }
        },
        y:{
          grid:{ display:false },
          ticks:{ color:'#333' }
        }
      },
      plugins:{
        legend:{ display:false },
        tooltip:{
          backgroundColor:'#111',
          titleColor:'#fff',
          bodyColor:'#fff',
          callbacks:{ label:ctx => ctx.raw.toFixed(3) }
        }
      }
    }
  });
}

// Add: helper to clear chart/results
let segmentPredictions = null; // segment-wise raw predictions

function clearChart() {
  if (chart) { try { chart.destroy(); } catch{} chart = null; }
  $('#results').empty();
  $('#downloadCsvBtn').prop('disabled', true).addClass('d-none');
}

async function fileToPCMWindows(file){
  const buf = await file.arrayBuffer();
  const ctx = new AudioContext({ sampleRate:48000 });
  const audio = await ctx.decodeAudioData(buf);
  const chan = audio.numberOfChannels > 1
    ? (()=>{ const l = audio.getChannelData(0), r = audio.getChannelData(1); const m = new Float32Array(audio.length); for(let i=0;i<audio.length;i++) m[i] = 0.5*(l[i] + r[i]); return m; })()
    : audio.getChannelData(0);
  let max = 0; for(let i=0;i<chan.length;i++){ const v=Math.abs(chan[i]); if(v>max) max=v; }
  const norm = max || 1;
  const pcm = new Float32Array(chan.length);
  for(let i=0;i<pcm.length;i++) pcm[i] = chan[i]/norm; // full-length, no truncation (worker frames with overlap)
  return { pcm };
}

// --- Init and handlers ---
// Removed eager model load at page load (no newWorker() here)

$('#chooseBtn').on('click',()=>$('#fileupload').trigger('click'));
$('#fileupload').on('change', async e => {
  const file = e.currentTarget.files[0];
  if(!file) return;

  clearChart();

  $('#fileInfo').text(file.name+' ('+(file.size/1024/1024).toFixed(2)+' MB)');
  initWaveSurfer(URL.createObjectURL(file));
  $('#statusLine').text('Decoding audio...');
  const { pcm } = await fileToPCMWindows(file);
  lastPCM = pcm;
  $('#statusLine').text('Audio ready. Adjust settings, then click "Run analysis".');
});

// Manual run
$('#runBtn').on('click', async () => {
  if (!lastPCM) { $('#statusLine').text('Please load audio first.'); return; }
  const selectedLang = $('#langSelect').val() || 'auto';
  if (!worker || !workerLoaded || selectedLang !== currentWorkerLang) {
    $('#statusLine').text('Loading model...');
    newWorker(selectedLang);
    await waitForLoaded();
  }
  const lat = parseFloat($('#latInput').val());
  const lon = parseFloat($('#lonInput').val());
  if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
    $('#statusLine').text('Applying geo scores...');
    worker.postMessage({ message:'area-scores', latitude: lat, longitude: lon });
  }
  const overlapSec = parseFloat($('#overlapSelect').val() || '1.5');
  $('#statusLine').text('Running prediction...');
  worker.postMessage({ message:'predict', pcmAudio: lastPCM, overlapSec });
});

$('#ws-container').on('mousedown',function(e){
  if(!ws) return;
  const x = e.clientX + window.scrollX - $(this).offset().left;
  ws.seekTo(Math.min(Math.max(x/$(this).width(),0),1));
});

$('#playBtn').on('click',()=> ws && ws.play());
$('#pauseBtn').on('click',()=> ws && ws.pause());
$('#restartBtn').on('click',()=> { if(ws){ ws.seekTo(0); ws.play(); } });
// Drag & drop
const dz=$('#dropzone');
dz.on('dragenter dragover',e=>{ e.preventDefault(); e.stopPropagation(); dz.addClass('upload-dropzone-hover'); });
dz.on('dragleave',e=>{ e.preventDefault(); e.stopPropagation(); dz.removeClass('upload-dropzone-hover'); });
dz.on('drop',async e=>{
  e.preventDefault(); e.stopPropagation();
  dz.removeClass('upload-dropzone-hover');
  $('#fileupload')[0].files = e.originalEvent.dataTransfer.files;
  $('#fileupload').trigger('change');
});

// CSV download
$('#downloadCsvBtn').on('click', () => {
  if(!segmentPredictions){ return; }
  const MIN_CONF = 0.1;
  const GEO_THRESH = 0.05;
  const useGeo = areaModelLoaded;
  let rows = ['start,end,label,score'];
  segmentPredictions.forEach(seg => {
    // filter predictions for this segment
    const filtered = seg.preds
      .filter(p => {
        if (p.confidence < MIN_CONF) return false;
        if (useGeo && !(p.geoscore > GEO_THRESH)) return false;
        return true;
      })
      .sort((a,b)=> b.confidence - a.confidence);
    filtered.forEach(p => {
      rows.push(
        `${seg.start.toFixed(3)},${seg.end.toFixed(3)},"${(p.nameI18n||p.name).replace(/"/g,'""')}",${p.confidence.toFixed(4)}`
      );
    });
  });
  if(rows.length === 1){
    rows.push('0,0,"(no detections)",0');
  }
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = ($('#fileupload')[0].files[0]?.name || 'audio').replace(/\.[^/.]+$/,'') + '_BirdNET_Results.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=> {
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 100);
});
</script>